<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sausages, Buns & Breads Master 2 - by Aakindumina</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Source+Sans+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ff6347; /* Tomato Red */
            --secondary-color: #ffd700; /* Gold */
            --accent-color: #4682b4; /* Steel Blue */
            --bg-color: #fdf5e6; /* Old Lace */
            --text-color: #4a4a4a;
            --font-title: 'Bangers', cursive;
            --font-body: 'Source Sans Pro', sans-serif;
        }

        /* General Styles & Resets */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: #1a1a1a;
            font-family: var(--font-body);
        }

        .game-container {
            position: relative; width: 100vw; height: 100vh;
            background: var(--bg-color);
            background-image: linear-gradient(45deg, #f5f5f5 25%, transparent 25%), linear-gradient(-45deg, #f5f5f5 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f5f5f5 75%), linear-gradient(-45deg, transparent 75%, #f5f5f5 75%);
            background-size: 20px 20px;
            overflow: hidden;
        }

        /* Screens */
        .screen {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            transition: opacity 0.5s, visibility 0.5s;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        /* Splash Screen & Intro */
        #splash-screen { background: #333; z-index: 100; color: white; }
        .splash-title { font-family: var(--font-title); font-size: clamp(2.5em, 10vw, 5em); color: var(--primary-color); text-shadow: 3px 3px 0 #000; }
        #intro-video { display: none; text-align: center; }
        .intro-text { animation: fadeIn 2s forwards; }
        .progress-bar-container { width: 80%; max-width: 400px; height: 30px; background: rgba(0,0,0,0.3); border-radius: 15px; margin-top: 20px; overflow: hidden; }
        #loading-bar { width: 0%; height: 100%; background: var(--primary-color); border-radius: 15px; transition: width 0.5s; }

        /* Main Menu */
        #main-menu { background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 90; }
        .game-title { font-family: var(--font-title); font-size: clamp(3em, 12vw, 6em); color: var(--secondary-color); text-shadow: 4px 4px 0 var(--primary-color), 8px 8px 0 #000; margin-bottom: 20px; animation: bounceIn 1s; }
        .menu-button {
            display: block; background-image: linear-gradient(to right, var(--primary-color), #ff8c69); color: white; border: none;
            border-radius: 50px; padding: 15px 30px; margin: 10px auto; font-family: var(--font-title);
            font-size: clamp(1.5em, 4vw, 2em); letter-spacing: 2px; min-width: 300px; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 6px 0 #c44d34;
        }
        .menu-button:hover { transform: translateY(-4px); box-shadow: 0 10px 0 #c44d34; }
        .menu-button:active { transform: translateY(2px); box-shadow: 0 4px 0 #c44d34; }
        .menu-button:disabled { background: #9e9e9e; box-shadow: 0 6px 0 #616161; cursor: not-allowed; }
        
        /* HUD */
        .hud {
            position: absolute; top: 10px; left: 10px; right: 10px;
            z-index: 50; display: flex; justify-content: space-between; align-items: center; pointer-events: none;
        }
        .hud-item {
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px;
            font-family: var(--font-title); font-size: clamp(1.2em, 4vw, 1.8em); display: flex;
            align-items: center; gap: 10px; box-shadow: 0 3px 5px rgba(0,0,0,0.3);
            border: 2px solid var(--secondary-color);
        }
        .hud-item button { background: none; border: none; color: white; font-family: var(--font-title); font-size: inherit; cursor: pointer; pointer-events: all; }
        
        /* Game Scene */
        #game-scene { flex-direction: row; }
        .left-panel, .right-panel { height: 100%; display: flex; flex-direction: column; justify-content: space-around; padding: 10px; }
        .work-area { flex-grow: 1; position: relative; background: #e0e0e0; border-left: 5px solid #333; border-right: 5px solid #333; }
        .machine-station { display: flex; flex-direction: column; align-items: center; background: #bdbdbd; padding: 10px; border-radius: 10px; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }
        .machine { width: 100px; height: 100px; background: #757575; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 3em; color: white; position: relative; cursor: pointer; }
        .machine.cooking { animation: sizzle 0.5s infinite; }
        .progress-ring { position: absolute; width: 110px; height: 110px; transform: rotate(-90deg); pointer-events: none; }
        .progress-ring__circle { stroke-dasharray: 315; stroke-dashoffset: 315; transition: stroke-dashoffset 0.1s linear; stroke: var(--secondary-color); stroke-width: 8px; fill: transparent; }
        
        .customer-area { position: absolute; top: 0; left: 0; right: 0; display: flex; justify-content: center; padding: 10px; gap: 10px; height: 120px; }
        .customer { position: relative; font-size: 3em; transition: transform 0.3s; }
        .customer.leaving { transform: translateY(-200%); }
        .order-bubble { position: absolute; bottom: 100%; background: white; padding: 5px; border-radius: 5px; font-size: 0.5em; white-space: nowrap; }

        .serving-tray { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: #a1887f; padding: 10px; border-radius: 10px; display: flex; gap: 10px; border: 3px solid #5d4037; }
        .serving-tray.shake { animation: shake 0.5s; }
        .tray-slot { width: 80px; height: 80px; background: rgba(0,0,0,0.2); border-radius: 5px; display: flex; justify-content: center; align-items: center; font-size: 2.5em; cursor: pointer; transition: transform 0.2s; }
        .tray-slot:hover { transform: scale(1.1); }

        .particle { position: absolute; pointer-events: none; border-radius: 50%; }

        /* Delivery Map Modal */
        #delivery-map-modal .modal-content { max-width: 90vw; max-height: 90vh; }
        #delivery-map { position: relative; width: 100%; aspect-ratio: 16/9; background: #a5d6a7; border-radius: 10px; overflow: hidden; }
        .delivery-vehicle { position: absolute; font-size: 2em; transition: all 3s linear; }
        .map-location { position: absolute; width: 40px; height: 40px; background: var(--primary-color); border-radius: 50%; transform: translate(-50%, -50%); display:flex; justify-content:center; align-items:center; }
        #delivery-info { margin-top: 10px; font-size: 1.2em; }
        
        /* Modals */
        .modal { background: rgba(0,0,0,0.7); z-index: 100; }
        .modal-content {
            background: var(--bg-color); padding: 20px; border-radius: 20px; border: 10px solid var(--secondary-color);
            width: 90%; max-width: 600px; max-height: 90%; text-align: center; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal-title { font-family: var(--font-title); color: var(--primary-color); font-size: clamp(2.5em, 8vw, 4em); margin: 0 0 20px 0; letter-spacing: 1px; }
        .modal-close {
            position: absolute; top: -20px; right: -20px; width: 45px; height: 45px; background: var(--primary-color);
            border: 4px solid white; border-radius: 50%; color: white; font-size: 1.5em; cursor: pointer;
            display: flex; justify-content: center; align-items: center; box-shadow: 0 3px 5px rgba(0,0,0,0.3);
        }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; max-height: 300px; overflow-y: auto; padding: 10px; }
        .shop-item { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .shop-item-icon { font-size: 3em; }
        .shop-item button { width: 100%; margin-top: 10px; }
        #about-creator { font-family: var(--font-title); font-size: 2em; animation: glow 2s infinite alternate; color: var(--primary-color); }
        
        /* Spin Wheel */
        .wheel-container { position: relative; width: 250px; height: 250px; margin: 20px auto; }
        #spin-wheel { width: 100%; height: 100%; background: conic-gradient(#ffeb3b 0% 12.5%, #ffc107 12.5% 25%, #8bc34a 25% 37.5%, #4caf50 37.5% 50%, #2196f3 50% 62.5%, #03a9f4 62.5% 75%, #e91e63 75% 87.5%, #f44336 87.5% 100%); border-radius: 50%; border: 5px solid #a1887f; transition: transform 4s cubic-bezier(0.25, 1, 0.5, 1); }
        .wheel-pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 30px solid #a1887f; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounceIn { 0%{transform:scale(0.1);opacity:0} 60%{transform:scale(1.2)} 100%{transform:scale(1);opacity:1} }
        @keyframes sizzle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        @keyframes glow { from { text-shadow: 0 0 5px #fff, 0 0 10px #ff6347, 0 0 15px #ff6347; } to { text-shadow: 0 0 10px #fff, 0 0 20px #ffd700, 0 0 30px #ffd700; } }
        @keyframes shake { 0%, 100% { transform: translateX(-50%); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-52%); } 20%, 40%, 60%, 80% { transform: translateX(-48%); } }
    </style>
</head>
<body>

    <div class="game-container">
        <!-- Screens -->
        <div id="game-scene" class="screen hidden">
            <div class="hud">
                <div id="level-hud" class="hud-item">LVL: 1</div>
                <div id="coins-hud" class="hud-item">💰 0</div>
                <div class="hud-item"><button id="delivery-btn">🚚</button></div>
            </div>
            <div class="left-panel">
                <div id="dough-station" class="machine-station">
                    <h3>Dough</h3>
                    <div id="dough-machine" class="machine" data-type="dough">🥣</div>
                </div>
                <div id="bread-station" class="machine-station">
                    <h3>Bread Oven</h3>
                    <div id="bread-oven" class="machine" data-type="bread">🍞</div>
                </div>
            </div>
            <div class="work-area">
                <div class="customer-area"></div>
                <div class="serving-tray"></div>
            </div>
            <div class="right-panel">
                <div id="sausage-station" class="machine-station">
                    <h3>Grill</h3>
                    <div id="sausage-grill" class="machine" data-type="sausage">🌭</div>
                </div>
                <div id="bun-station" class="machine-station">
                    <h3>Toaster</h3>
                    <div id="bun-toaster" class="machine" data-type="bun">🥯</div>
                </div>
            </div>
        </div>

        <div id="main-menu" class="screen">
            <div class="menu-container">
                <h1 class="game-title">Sausages, Buns & Breads Master 2</h1>
                <button data-action="play" class="menu-button">Play</button>
                <button data-action="shop" class="menu-button">Shop</button>
                <button data-action="recipes" class="menu-button">Recipes</button>
                <button data-action="rewards" class="menu-button">Daily Reward</button>
                <button data-action="about" class="menu-button">About</button>
            </div>
        </div>
        
        <div id="splash-screen" class="screen">
            <h1 class="splash-title">Sausages, Buns & Breads Master 2</h1>
            <div id="intro-video">
                <h2 id="intro-text-1" class="intro-text">From a humble stall...</h2>
                <h2 id="intro-text-2" class="intro-text" style="display:none;">...to a bustling bakery...</h2>
                <h2 id="intro-text-3" class="intro-text" style="display:none;">...to a global empire!</h2>
            </div>
            <div class="progress-bar-container"><div id="loading-bar"></div></div>
        </div>

        <!-- Modals -->
        <div id="shop-modal" class="modal screen hidden"><div class="modal-content"><button class="modal-close">X</button><h2 class="modal-title">Shop</h2><div id="shop-grid" class="shop-grid"></div></div></div>
        <div id="recipe-book-modal" class="modal screen hidden"><div class="modal-content"><button class="modal-close">X</button><h2 class="modal-title">Recipe Book</h2><div id="recipe-list" class="shop-grid"></div></div></div>
        <div id="about-modal" class="modal screen hidden"><div class="modal-content"><button class="modal-close">X</button><h2 class="modal-title">About</h2><p id="about-creator">Created by Aakindumina</p></div></div>
        <div id="level-complete-modal" class="modal screen hidden"><div class="modal-content"><h2 class="modal-title">Level Complete!</h2><p id="level-complete-stats"></p><button id="next-level-btn" class="menu-button">Next Level</button></div></div>
        <div id="rewards-modal" class="modal screen hidden"><div class="modal-content"><button class="modal-close">X</button><h2 class="modal-title">Daily Reward</h2><div class="wheel-container"><div class="wheel-pointer"></div><div id="spin-wheel"></div></div><button id="spin-btn" class="menu-button">SPIN!</button></div></div>
        <div id="delivery-map-modal" class="modal screen hidden"><div class="modal-content"><button class="modal-close">X</button><h2 class="modal-title">Delivery Map</h2><div id="delivery-map"></div><div id="delivery-info"></div><button id="send-delivery-btn" class="menu-button">Send Delivery</button></div></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Data Definitions ---
    const RECIPES = {
        hotdog: { name: 'Classic Hotdog', emoji: '🌭', requires: ['sausage', 'bun'], price: 10 },
        toast: { name: 'Golden Toast', emoji: '🍞', requires: ['bread'], price: 5 },
        bagel: { name: 'Toasted Bagel', emoji: '🥯', requires: ['bun'], price: 8 },
    };
    const UPGRADES = {
        dough_machine: { name: 'Mixer', level: 1, cost: 50, timeReduction: 0.1 },
        bread_oven: { name: 'Bread Oven', level: 1, cost: 75, timeReduction: 0.1 },
        sausage_grill: { name: 'Sausage Grill', level: 1, cost: 60, timeReduction: 0.1 },
        bun_toaster: { name: 'Bun Toaster', level: 1, cost: 40, timeReduction: 0.1 },
        tray: { name: 'Serving Tray', level: 1, cost: 100, capacity: 3 },
        delivery_bike: { name: 'Bike', unlocked: true, level: 1, cost: 200, speed: 3000, capacity: 5, emoji: '🚲' },
        delivery_van: { name: 'Van', unlocked: false, cost: 1000, speed: 2000, capacity: 20, emoji: '🚐' },
    };
    const BASE_TIMES = { dough: 3000, bread: 5000, sausage: 4000, bun: 2500 };
    
    // --- DOM Elements ---
    const screens = { splash: document.getElementById('splash-screen'), menu: document.getElementById('main-menu'), game: document.getElementById('game-scene') };
    const modals = { shop: document.getElementById('shop-modal'), recipeBook: document.getElementById('recipe-book-modal'), about: document.getElementById('about-modal'), levelComplete: document.getElementById('level-complete-modal'), deliveryMap: document.getElementById('delivery-map-modal'), rewards: document.getElementById('rewards-modal') };
    const hud = { level: document.getElementById('level-hud'), coins: document.getElementById('coins-hud'), deliveryBtn: document.getElementById('delivery-btn') };
    const machines = { dough: document.getElementById('dough-machine'), bread: document.getElementById('bread-oven'), sausage: document.getElementById('sausage-grill'), bun: document.getElementById('bun-toaster') };
    const gameElements = { customerArea: document.querySelector('.customer-area'), servingTray: document.querySelector('.serving-tray'), deliveryMap: document.getElementById('delivery-map'), deliveryInfo: document.getElementById('delivery-info'), sendDeliveryBtn: document.getElementById('send-delivery-btn') };

    // --- Game State ---
    let gameState = {};

    // --- Main Controller ---
    function init() { if (!loadGame()) newGame(); runIntro(); setupEventListeners(); }
    function newGame() {
        gameState = {
            level: 1, coins: 50, lastSpinDate: null,
            upgrades: JSON.parse(JSON.stringify(UPGRADES)),
            gameLoop: null, customers: [], tray: [], levelEnding: false,
            cooking: { dough: null, bread: null, sausage: null, bun: null },
            delivery: { onDelivery: false },
            levelData: {}
        };
    }

    function runIntro() {
        let loadProgress = 0; const loadingBar = document.getElementById('loading-bar');
        const loadInterval = setInterval(() => {
            loadProgress += 20; loadingBar.style.width = `${loadProgress}%`;
            if (loadProgress >= 100) {
                clearInterval(loadInterval);
                setTimeout(() => {
                    loadingBar.parentElement.style.display = 'none';
                    const introVideo = document.getElementById('intro-video');
                    introVideo.style.display = 'block';
                    const texts = [document.getElementById('intro-text-1'), document.getElementById('intro-text-2'), document.getElementById('intro-text-3')];
                    let currentText = 0;
                    texts[0].style.display = 'block';
                    const textInterval = setInterval(() => {
                        texts[currentText].style.display = 'none';
                        currentText++;
                        if (currentText < texts.length) {
                            texts[currentText].style.display = 'block';
                        } else {
                            clearInterval(textInterval);
                            switchScreen('menu');
                        }
                    }, 2000);
                }, 500);
            }
        }, 300);
    }
    
    function switchScreen(screenName) {
        Object.values(screens).forEach(s => s.classList.add('hidden'));
        if (screens[screenName]) screens[screenName].classList.remove('hidden');
    }

    function startGame() {
        switchScreen('game');
        loadLevel(gameState.level);
        if (gameState.gameLoop) clearInterval(gameState.gameLoop);
        gameState.gameLoop = setInterval(gameTick, 100);
    }

    function loadLevel(level) {
        gameState.levelData = {
            level: level,
            required: 5 + Math.floor(level * 1.5),
            customersServed: 0,
            maxCustomers: Math.min(4, 2 + Math.floor(level / 3)),
            recipes: level < 3 ? ['hotdog'] : Object.keys(RECIPES)
        };
        resetLevelVisuals();
        updateHUD();
    }

    function gameTick() {
        if (!gameState.levelEnding && gameState.customers.length < gameState.levelData.maxCustomers) {
            if (Math.random() < 0.02) spawnCustomer();
        }
    }

    function resetLevelVisuals() {
        gameState.customers.forEach(c => c.element.remove());
        gameState.customers = [];
        gameState.tray = [];
        Object.keys(gameState.cooking).forEach(type => {
            if (gameState.cooking[type]?.interval) clearInterval(gameState.cooking[type].interval);
            gameState.cooking[type] = null;
            const machineEl = machines[type];
            if (machineEl) {
                 machineEl.classList.remove('cooking');
                 const ring = machineEl.querySelector('circle');
                 if(ring) ring.style.strokeDashoffset = 315;
            }
        });
        gameElements.customerArea.innerHTML = '';
        renderTray();
    }
    
    // --- Customer & Serving Logic ---
    function spawnCustomer() {
        const recipeId = gameState.levelData.recipes[Math.floor(Math.random() * gameState.levelData.recipes.length)];
        const customer = { id: Date.now(), recipeId, element: document.createElement('div') };
        customer.element.className = 'customer';
        customer.element.innerHTML = `<span>${Math.random() > 0.5 ? '🧑' : '👧'}</span><div class="order-bubble">${RECIPES[recipeId].emoji}</div>`;
        gameElements.customerArea.appendChild(customer.element);
        gameState.customers.push(customer);
    }

    function serveCustomer(trayIndex) {
        const product = gameState.tray[trayIndex];
        if (!product) return;

        const customerIndex = gameState.customers.findIndex(c => product.recipeId === c.recipeId);
        if (customerIndex > -1) {
            const customer = gameState.customers[customerIndex];
            customer.element.classList.add('leaving');
            setTimeout(() => customer.element.remove(), 500);
            gameState.customers.splice(customerIndex, 1);
            
            gameState.coins += product.price;
            gameState.levelData.customersServed++;
            updateHUD();

            gameState.tray.splice(trayIndex, 1);
            renderTray();

            if (!gameState.levelEnding && gameState.levelData.customersServed >= gameState.levelData.required) {
                gameState.levelEnding = true;
                if(gameState.customers.length === 0) levelUp();
            }
        }
    }

    function levelUp() {
        clearInterval(gameState.gameLoop);
        gameState.gameLoop = null;
        modals.levelComplete.classList.remove('hidden');
        document.getElementById('level-complete-stats').textContent = `You passed level ${gameState.level}!`;
        gameState.level++;
        saveGame();
    }

    // --- Cooking Logic ---
    function startCooking(type) {
        if (gameState.cooking[type]) return;

        let machineId;
        switch(type) {
            case 'dough': machineId = 'dough_machine'; break;
            case 'bread': machineId = 'bread_oven'; break;
            case 'sausage': machineId = 'sausage_grill'; break;
            case 'bun': machineId = 'bun_toaster'; break;
            default: console.error("Unknown machine type:", type); return;
        }

        const upgrade = gameState.upgrades[machineId];
        const cookTime = BASE_TIMES[type] * (1 - (upgrade.level - 1) * upgrade.timeReduction);

        gameState.cooking[type] = { startTime: Date.now(), duration: cookTime };
        
        const machineEl = machines[type];
        machineEl.classList.add('cooking');
        const ring = machineEl.querySelector('circle') || createProgressRing(machineEl);
        
        const interval = setInterval(() => {
            if(!gameState.cooking[type]) { clearInterval(interval); return; }
            const elapsed = Date.now() - gameState.cooking[type].startTime;
            const progress = Math.min(elapsed / cookTime, 1);
            ring.style.strokeDashoffset = 315 * (1 - progress);

            if (progress >= 1) {
                clearInterval(gameState.cooking[type].interval);
                finishCooking(type);
            }
        }, 50);
        gameState.cooking[type].interval = interval;
    }

    function finishCooking(type) {
        const machineEl = machines[type];
        machineEl.classList.remove('cooking');
        const ring = machineEl.querySelector('circle');
        if(ring) ring.style.strokeDashoffset = 315;
        
        createParticles(machineEl, 10);
        
        gameState.cooking[type] = null;
        let product;
        switch (type) {
            case 'bread': product = { type: 'bread', recipeId: 'toast', price: RECIPES.toast.price }; break;
            case 'sausage': product = { type: 'sausage' }; break;
            case 'bun': product = { type: 'bun', recipeId: 'bagel', price: RECIPES.bagel.price }; break;
            case 'dough': startCooking('bread'); return;
        }

        addToTray(product);
    }

    function addToTray(product) {
        if (gameState.tray.length >= gameState.upgrades.tray.level + 2) { // 3 base capacity
            gameElements.servingTray.classList.add('shake');
            setTimeout(() => gameElements.servingTray.classList.remove('shake'), 500);
            return;
        }

        // Attempt to assemble hotdog
        if (product.type === 'sausage') {
            const bunIndex = gameState.tray.findIndex(item => item.type === 'bun');
            if (bunIndex > -1) {
                gameState.tray.splice(bunIndex, 1);
                product = { type: 'hotdog', recipeId: 'hotdog', price: RECIPES.hotdog.price };
            }
        } else if (product.type === 'bun') {
            const sausageIndex = gameState.tray.findIndex(item => item.type === 'sausage');
            if (sausageIndex > -1) {
                gameState.tray.splice(sausageIndex, 1);
                product = { type: 'hotdog', recipeId: 'hotdog', price: RECIPES.hotdog.price };
            }
        }
        
        gameState.tray.push(product);
        renderTray();
    }
    
    function renderTray() {
        gameElements.servingTray.innerHTML = '';
        gameState.tray.forEach((item, index) => {
            const slot = document.createElement('div');
            slot.className = 'tray-slot';
            slot.textContent = RECIPES[item.recipeId]?.emoji || (item.type === 'bun' ? '🥯' : (item.type === 'sausage' ? '🌭' : '❓'));
            slot.onclick = () => serveCustomer(index);
            gameElements.servingTray.appendChild(slot);
        });
    }

    function createProgressRing(parent) {
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute('class', 'progress-ring'); svg.setAttribute('viewBox', '0 0 110 110');
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute('class', 'progress-ring__circle');
        circle.setAttribute('r', '50'); circle.setAttribute('cx', '55'); circle.setAttribute('cy', '55');
        svg.appendChild(circle); parent.appendChild(svg);
        return circle;
    }

    // --- UI & Event Listeners ---
    function setupEventListeners() {
        document.querySelector('#main-menu').addEventListener('click', e => {
            if(!e.target.matches('[data-action]')) return;
            const action = e.target.dataset.action;
            if (action === 'play') startGame();
            else if (action === 'shop') openModal(modals.shop);
            else if (action === 'recipes') openModal(modals.recipeBook);
            else if (action === 'about') openModal(modals.about);
            else if (action === 'rewards') openModal(modals.rewards);
        });
        Object.values(modals).forEach(m => {
            const closeBtn = m.querySelector('.modal-close');
            if(closeBtn) closeBtn.addEventListener('click', () => closeModal(m));
        });
        hud.deliveryBtn.addEventListener('click', () => openModal(modals.deliveryMap));
        gameElements.sendDeliveryBtn.addEventListener('click', sendDelivery);
        document.getElementById('next-level-btn').addEventListener('click', () => {
            closeModal(modals.levelComplete);
            startGame();
        });

        Object.values(machines).forEach(machine => {
            machine.addEventListener('click', () => startCooking(machine.dataset.type));
        });

        modals.shop.addEventListener('click', e => {
            if(e.target.matches('[data-buy-id]')) buyItem(e.target.dataset.buyId);
        });
        document.getElementById('spin-btn').addEventListener('click', handleSpin);
    }

    function updateHUD() {
        hud.level.textContent = `LVL: ${gameState.level}`;
        hud.coins.textContent = `💰 ${gameState.coins}`;
    }
    
    function openModal(modal) {
        if (modal === modals.shop) renderShop();
        if (modal === modals.recipeBook) renderRecipeBook();
        if (modal === modals.deliveryMap) renderDeliveryMap();
        modal.classList.remove('hidden');
    }
    function closeModal(modal) { modal.classList.add('hidden'); }

    // --- Shop, Delivery & Rewards ---
    function renderShop() {
        const grid = modals.shop.querySelector('#shop-grid'); grid.innerHTML = '';
        Object.entries(gameState.upgrades).forEach(([id, item]) => {
            const cost = item.unlocked === false ? item.cost : item.cost * item.level;
            const itemEl = document.createElement('div'); itemEl.className = 'shop-item';
            itemEl.innerHTML = `<div class="shop-item-icon">${id.includes('delivery') ? item.emoji : '🔧'}</div><div>${item.name}${item.unlocked ? ` Lvl ${item.level}` : ''}</div><strong>💰 ${cost}</strong><button class="menu-button" data-buy-id="${id}" ${gameState.coins < cost ? 'disabled' : ''}>${item.unlocked === false ? 'Unlock' : 'Upgrade'}</button>`;
            grid.appendChild(itemEl);
        });
    }
    
    function buyItem(id) {
        const item = gameState.upgrades[id];
        const cost = item.unlocked === false ? item.cost : item.cost * item.level;
        if (gameState.coins >= cost) {
            gameState.coins -= cost;
            if(item.unlocked === false) item.unlocked = true;
            else item.level++;
            updateHUD(); renderShop(); saveGame();
        }
    };

    function renderDeliveryMap() {
        gameElements.deliveryMap.innerHTML = '';
        const home = document.createElement('div');
        home.className = 'map-location'; home.textContent = '🏠';
        home.style.left = '10%'; home.style.top = '50%';
        gameElements.deliveryMap.appendChild(home);

        const vehicle = document.createElement('div');
        vehicle.className = 'delivery-vehicle';
        const currentVehicle = gameState.upgrades.delivery_van.unlocked ? 'delivery_van' : 'delivery_bike';
        vehicle.textContent = gameState.upgrades[currentVehicle].emoji;
        vehicle.style.left = '10%'; vehicle.style.top = '50%';
        gameElements.deliveryMap.appendChild(vehicle);
        
        const capacity = gameState.upgrades[currentVehicle].capacity;
        gameElements.deliveryInfo.textContent = `Load up to ${capacity} items for delivery. Current load: ${gameState.tray.length}`;
        gameElements.sendDeliveryBtn.disabled = gameState.tray.length === 0 || gameState.delivery.onDelivery;
    }

    function sendDelivery() {
        if (gameState.tray.length === 0 || gameState.delivery.onDelivery) return;
        const currentVehicleId = gameState.upgrades.delivery_van.unlocked ? 'delivery_van' : 'delivery_bike';
        const vehicleData = gameState.upgrades[currentVehicleId];
        
        const itemsToSend = gameState.tray.splice(0, vehicleData.capacity);
        renderTray();
        
        gameState.delivery.onDelivery = true;
        gameElements.sendDeliveryBtn.disabled = true;
        
        const vehicleEl = gameElements.deliveryMap.querySelector('.delivery-vehicle');
        vehicleEl.style.transition = `all ${vehicleData.speed / 1000}s linear`;

        // Animate delivery
        setTimeout(() => { vehicleEl.style.left = '90%'; vehicleEl.style.top = '20%'; }, 100);
        
        // Handle return and reward
        setTimeout(() => {
            vehicleEl.style.left = '10%'; vehicleEl.style.top = '50%';
            const earnings = itemsToSend.reduce((sum, item) => sum + item.price, 0);
            gameState.coins += earnings;
            updateHUD();
            gameState.delivery.onDelivery = false;
            renderDeliveryMap(); // Update button state
            saveGame();
        }, vehicleData.speed + 100);
    }
    
    function handleSpin() {
        const today = new Date().toDateString(); if (gameState.lastSpinDate === today) { alert("You've already claimed your reward for today!"); return; }
        const spinBtn = document.getElementById('spin-btn'), spinWheel = document.getElementById('spin-wheel');
        const degrees = Math.floor(Math.random() * 3600) + 1800;
        const prizes = [100, 50, 200, 10, 500, 25, 5, 75];
        spinWheel.style.transform = `rotate(${degrees}deg)`; spinBtn.disabled = true;
        setTimeout(() => {
            const wonPrize = prizes[Math.floor(((degrees % 360) / 360) * 8)]; alert(`You won ${wonPrize} coins!`);
            gameState.coins += wonPrize; gameState.lastSpinDate = today; updateHUD();
            spinBtn.disabled = false; closeModal(modals.rewards); saveGame();
        }, 4100);
    }

    function renderRecipeBook() {
        const list = modals.recipeBook.querySelector('#recipe-list'); list.innerHTML = '';
        Object.values(RECIPES).forEach(recipe => {
            const el = document.createElement('div'); el.className = 'shop-item';
            el.innerHTML = `<div class="shop-item-icon">${recipe.emoji}</div><div>${recipe.name}</div>`;
            list.appendChild(el);
        });
    }

    // --- Utility, Save & Load ---
    function createParticles(parent, count) {
        const rect = parent.getBoundingClientRect();
        for (let i=0; i < count; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.width = `${Math.random() * 5 + 2}px`;
            p.style.height = p.style.width;
            p.style.background = `rgba(255, 255, 255, ${Math.random()})`;
            p.style.position = 'absolute';
            p.style.left = `${rect.left + rect.width / 2}px`;
            p.style.top = `${rect.top + rect.height / 2}px`;
            document.body.appendChild(p);
            p.animate([
                { transform: 'translate(-50%, -50%) scale(1)', opacity: 1},
                { transform: `translate(calc(-50% + ${(Math.random() - 0.5) * 100}px), calc(-50% + ${(Math.random() - 0.5) * 100}px)) scale(0)`, opacity: 0}
            ], { duration: 800, easing: 'ease-out'}).onfinish = () => p.remove();
        }
    }
    function saveGame() {
        try { localStorage.setItem('sausageMaster2Save', JSON.stringify({ level: gameState.level, coins: gameState.coins, upgrades: gameState.upgrades, lastSpinDate: gameState.lastSpinDate })); } catch (e) { console.error("Save failed", e); }
    }
    function loadGame() {
        try {
            const saved = localStorage.getItem('sausageMaster2Save');
            if (saved) {
                const data = JSON.parse(saved); newGame();
                gameState.level = data.level || 1;
                gameState.coins = data.coins || 50;
                gameState.lastSpinDate = data.lastSpinDate || null;
                if(data.upgrades) {
                    for (const key in gameState.upgrades) {
                        if(data.upgrades[key]) gameState.upgrades[key] = data.upgrades[key];
                    }
                }
                return true;
            }
            return false;
        } catch (e) { console.error("Load failed", e); return false; }
    }

    init();
});
</script>

</body>
</html>

